<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>spdlog的一些坑 - int main() { return 0; }</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=author content><meta name=keywords content><link rel=canonical href=/2017/02/01/spdlog%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/><link rel=stylesheet type=text/css href='//fonts.googleapis.com/css?family=Lato:900,400,300'><link rel=stylesheet type=text/css href=//css/combined-min.css></head><body><div class=site-wrap><header class="site-header px2 px-responsive"><div class="mt2 wrap"><div class=measure><a href=/ class=site-title>int main() { return 0; }</a><nav class="site-nav right"><a href=//about/>About</a>
<a href=//tags/>Tags</a>
<a href=https://intmainreturn0.com/cv>Resume</a>
<a href=//contact/>Contact</a></form></nav><div class=clearfix></div></div></div></header><div class="post p2 p-responsive wrap" role=main><div class=measure><div class="post-header mb2"><h1 class=py2>spdlog的一些坑</h1><span class=post-meta>Jan 31, 2017 by htfy96</span><br></div><article class=post-content><p>最近在用C++的这个spdlog库中遇到了一些坑……在这里写一下</p><h2 id=线程不安全>线程不安全</h2><p>这个库宣称自己是线程安全的，实际上它做的是：</p><p>这里有两个地方不安全</p><h3 id=localtime_r>localtime_r</h3><blockquote></blockquote><p>│ctime_r(), │ Thread safety │ MT-Safe env locale │
│gmtime_r(), │ │ │
│localtime_r(), │ │ │
│mktime() │ │ │
├───────────────┼───────────────┼─────────────────────────────────┤</p><p>localtime_r虽然是MT-Safe的，但它对env, locale的读取没有做任何同步措施。因此中途如果另一个线程对env/locale发生了修改，可能会发生各种各样神奇的事故。当然，这个是次要的问题，更主要的问题在下面。</p><h3 id=operator-ostream-void-const>operator &#171;(ostream&, void *const)</h3><p>大家可能常常觉得只要cout那里锁住了就好，实际上并不如此。上面这段代码用valgrind –tool=drd跑一下就会出现如下警告：</p><p>如上所示，即使两个完全不同的ostream的operator &#171; 也有可能发生data race，这就很尴尬了。这是因为在operator&#171;中调用了locale的widen方法，widen方法是怎么实现的呢？下面是libstdc++ 6.2.1 bits/locale_facet.h的实现：</p><p>很明显这里没有任何同步措施。这就造成了spdlog坑居多……</p><p>正确的做法是什么呢？</p><p>待续。。（翻了一圈GTest好像也没有考虑这点……而且也不像是libstdc++的bug……</p></article><p class=post-meta>Tags:&nbsp;
<a href=//tags/c++>c++</a>
,&nbsp;
<a href=//tags/spdlog>spdlog</a>
,&nbsp;
<a href=//tags/%e5%a4%9a%e7%ba%bf%e7%a8%8b>多线程</a></p></div></div></div><footer class=footer><div class="p2 wrap"><div class="measure mt1 center"><nav class="social-icons icons"><a class="fa fa-rss rss" href=/index.xml></a>
<a class="fa fa-twitter twitter" href=https://twitter.com/HTwood96></a></nav><small>Copyright &#169; 2017<br>Powered by <a href=http://gohugo.io/ target=_blank>Hugo</a> & <a href=https://github.com/azmelanar/hugo-theme-pixyll target=_blank>Pixyll</a></small></div></div></footer><script src=/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>