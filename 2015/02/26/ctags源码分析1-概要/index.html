<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <title>cTags源码分析(1) – 概要 - int main() { return 0; }</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="https://intmainreturn0.com/2015/02/26/ctags%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901-%E6%A6%82%E8%A6%81/">

  
  <link rel="stylesheet" type="text/css" href="https://intmainreturn0.com/css/basscss.css">
  <link rel="stylesheet" type="text/css" href="https://intmainreturn0.com/css/main.css">

  
  <link rel="stylesheet" type="text/css" href="https://intmainreturn0.com/css/highlight/styles/railscasts.css">

  
  <link rel='stylesheet' type='text/css' href='//fonts.googleapis.com/css?family=Lato:900,400,300'> 
  

  

  
  

</head>

<body class="">
<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://intmainreturn0.com" class="site-title">int main() { return 0; }</a>
      <nav class="site-nav right">
      <a href="https://intmainreturn0.com/about/">About</a>
<a href="https://intmainreturn0.com/tags/">Tags</a>
<a href="https://intmainreturn0.com/cv">Resume</a>
<a href="https://intmainreturn0.com/contact/">Contact</a>
</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">cTags源码分析(1) – 概要</h1>
        <span class="post-meta">Feb 25, 2015 by htfy96</span><br>
        
      </div>

      <article class="post-content">
      <blockquote>
<p>本文分析的是cTags5.8源代码，<a href="http://sourceforge.net/projects/ctags/">http://sourceforge.net/projects/ctags/</a> 可以从这里获得</p>
</blockquote>

<p>从<code>main.c</code>开始。</p>

<pre><code class="language-cpp">extern int main (int __unused__ argc, char **argv)
{
    cookedArgs *args;
#ifdef VMS
    extern int getredirection (int *ac, char ***av);

    /* do wildcard expansion and I/O redirection */
    getredirection (&argc, &argv);
#endif

#ifdef AMIGA
    /* This program doesn't work when started from the Workbench */
    if (argc == 0)
        exit (1);
#endif

#ifdef __EMX__
    _wildcard (&argc, &argv);  /* expand wildcards in argument list */
#endif

#if defined (macintosh) && BUILD_MPW_TOOL == 0
    argc = ccommand (&argv);
#endif

    setCurrentDirectory ();
    setExecutableName (*argv++);
    checkRegex ();

    args = cArgNewFromArgv (argv);
    previewFirstOption (args);
    testEtagsInvocation ();
    initializeParsing ();
    initOptions ();
    readOptionConfiguration ();
    verbose ("Reading initial options from command line
");
    parseOptions (args);
    checkOptions ();
    makeTags (args);

    /*  Clean up.
     */
    cArgDelete (args);
    freeKeywordTable ();
    freeRoutineResources ();
    freeSourceFileResources ();
    freeTagFileResources ();
    freeOptionResources ();
    freeParserResources ();
    freeRegexResources ();

    exit (0);
    return 0;
}</code></pre>

<p>一开始cTags维护了一个自己的<code>cookedArgs</code>类型的参数列表，<code>args</code>。之后根据不同系统的情况，重新定义了<code>argc</code>与<code>argv</code>。</p>

<p>第一个函数<code>setCurrentDirectory()</code>定义在<code>routines.c</code>中，根据系统不同，定义了<code>CurrentDirectory</code>一个全局变量（使用<code>getcwd()</code>），并在最后增加了<code>OUTPUT_PATH_SEPARATOR</code>。</p>

<p>第二个函数<code>setExecutableName (*argv++)</code>定义了<code>ExecutableProgram</code>(主文件路径)和<code>ExecutableName</code>(主文件名)两个全局变量。</p>

<p>第三个函数<code>checkRegex()</code>是<code>regex</code>库的内部函数，检查<code>regex</code>能否正常工作.</p>

<p>之后，<code>args = cArgNewFromArgv (argv)</code>将默认的选项格式加以处理转换到<code>args</code>中.</p>

<p><code>previewFirstOption (args)</code>处理<code>-v</code>和没有选项的情况（直接退出）。</p>

<p><code>testEtagsInvocation ()</code>检测是否有<code>-e</code>选项，若有，则初始化<code>etags</code>。</p>

<p><code>initializeParsing()</code>是重要的一步，它检查每一个内建的语言，它们的名称是否合法，它们的<code>regex</code>是否存在，如果是，则将它们插入<code>LanguageTable[]</code>数组中。这个数组的成员类型是<code>parserDefinition*</code>,而<code>parserDefinition</code>的定义如下：</p>

<pre><code class="language-c">typedef struct {
    /* defined by parser */
    char* name;                    /* name of language */
    kindOption* kinds;             /* tag kinds handled by parser */
    unsigned int kindCount;        /* size of `kinds' list */
    const char *const *extensions; /* list of default extensions */
    const char *const *patterns;   /* list of default file name patterns */
    parserInitialize initialize;   /* initialization routine, if needed （初始化的函数指针） */
    simpleParser parser;           /* simple parser (common case) */
    rescanParser parser2;          /* rescanning parser (unusual case) */
    boolean regex;                 /* is this a regex parser? */

    /* used internally */
    unsigned int id;               /* id assigned to language */
    boolean enabled;               /* currently enabled? */
    stringList* currentPatterns;   /* current list of file name patterns */
    stringList* currentExtensions; /* current list of extensions */
} parserDefinition;</code></pre>

<p>之后<code>initializeParsing</code>调用<code>initializeParsers ()</code>，即循环调用每个<code>LanguageTable[]</code>中语言的<code>LanguageTable[i]-&gt;initialize()</code>，进行语言初始化工作（建立hash表等）。</p>

<p>接下来的一大步是<code>initOptions()</code>,设置默认选项，建立默认语言映射，自动添加<code>.git</code>等控制文件到<code>--exclude</code>选项中。</p>

<p><code>readOptionConfiguration ()</code>读取目录下的<code>.ctags</code>配置文件与环境变量。</p>

<p><code>parseOptions (args)</code>把之前简单分拆的选项细分成<code>longOptions</code>和<code>shortOptions</code>，并设置<code>Options</code>结构的相应位。</p>

<p><code>checkOptions()</code>是对选项的静态检查。</p>

<p><code>makeTags(args)</code>，是最重要的部分，代码如下：</p>

<pre><code class="language-c">static void makeTags (cookedArgs *args)
{
    clock_t timeStamps [3];
    boolean resize = FALSE;
    boolean files = (boolean)(! cArgOff (args) || Option.fileList != NULL
                              || Option.filter);

    if (! files)
    {
        if (filesRequired ())
            error (FATAL, "No files specified. Try "%s --help".",
                getExecutableName ());
        else if (! Option.recurse && ! etagsInclude ())
            return;
    }

#define timeStamp(n) timeStamps[(n)]=(Option.printTotals ? clock():(clock_t)0)
    if (! Option.filter)
        openTagFile ();

    timeStamp (0);

    if (! cArgOff (args))
    {
        verbose ("Reading command line arguments
");
        resize = createTagsForArgs (args);
    }
    if (Option.fileList != NULL)
    {
        verbose ("Reading list file
");
        resize = (boolean) (createTagsFromListFile (Option.fileList) || resize);
    }
    if (Option.filter)
    {
        verbose ("Reading filter input
");
        resize = (boolean) (createTagsFromFileInput (stdin, TRUE) || resize);
    }
    if (! files  &&  Option.recurse)
        resize = recurseIntoDirectory (".");

    timeStamp (1);

    if (! Option.filter)
        closeTagFile (resize);

    timeStamp (2);

    if (Option.printTotals)
        printTotals (timeStamps);
#undef timeStamp
}</code></pre>

<p>简而言之，就是以下几步：</p>

<ol>
<li><code>openTagFile (resize)</code>打开Tag文件；</li>
<li>根据选项不同，分别调用<code>createTagsForArgs (args)</code>、<code>createTagsFromListFile (Option.fileList)</code>、<code>createTagsFromFileInput (stdin, TRUE)</code>、<code>recurseIntoDirectory (&quot;.&quot;)</code>，而它们都调用了<code>createTagsForEntry(filename)</code>，经过检查后，最终调用了<code>parse.c</code>中的<code>parseFile(filename)</code>;</li>
<li><code>closeTagFile (resize)</code>关闭Tag文件。</li>
</ol>

<p>最终，通过如下几步，<code>free</code>掉前几步申请的动态内存，防止内存泄漏:</p>

<pre><code class="language-c">    cArgDelete (args);  //释放args[]
    freeKeywordTable ();  //释放KeywordTable[]
    freeRoutineResources ();  //释放CurrentDirectory
    freeSourceFileResources ();  //释放File（一个用于读取文件的变量）
    freeTagFileResources ();  //释放TagFile变量
    freeOptionResources ();  //释放Options变量
    freeParserResources ();  //释放LanguageTable[]
    freeRegexResources ();  //释放Regex库内存</code></pre>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
      </p>

      

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
this.page.url = "https:\/\/intmainreturn0.com\/2015\/02\/26\/ctags%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901-%E6%A6%82%E8%A6%81\/";  
this.page.identifier = "\/2015\/02\/26\/ctags%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901-%E6%A6%82%E8%A6%81\/";
};
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://' + 'intmainreturn0-com' + ".disqus.com/embed.js";
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="https://intmainreturn0.com/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/HTwood96"></a>

</nav>

          <small>
            Copyright &#169; 2017<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="https://intmainreturn0.com/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


</body>
</html>

